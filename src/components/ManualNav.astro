---
import { getCollection } from "astro:content";
import {
  parseManualCollectionId,
  getManualPagesByGroup,
  getManualPageUrl,
  formatChapterTitle,
} from "@/utils/manuals";
import type { ManualNavItem } from "@/@types/manual";

interface Props {
  id: string;
}

const { id } = Astro.props;
const { group } = parseManualCollectionId(id, true);

const allPages = await getCollection("manualsPages");
const manualPages = getManualPagesByGroup(allPages, group);

const navigationItems: (
  | ManualNavItem
  | { isChapter: true; title: string; orderChapter: number }
)[] = [];
let lastChapter: string | undefined = undefined;

manualPages.forEach((page, index) => {
  const parsed = parseManualCollectionId(page.id, true);
  const isFirstPage = index === 0;

  // Se c'Ã¨ un nuovo capitolo, aggiungi l'header del capitolo
  if (parsed.chapter && parsed.chapter !== lastChapter) {
    const chapterTitle = formatChapterTitle(parsed.chapter);
    if (chapterTitle) {
      navigationItems.push({
        isChapter: true,
        title: chapterTitle,
        orderChapter: parsed.orderChapter || 999,
      });
    }
    lastChapter = parsed.chapter;
  }

  navigationItems.push({
    slug: parsed.slug,
    title: parsed.title,
    url: getManualPageUrl(group, parsed.slug, isFirstPage),
    active: page.id === id,
    chapter: parsed.chapter,
    orderChapter: parsed.orderChapter,
  });
});
---

<button
  class="fixed left-1 z-50 flex h-10 w-10 cursor-pointer flex-col items-center justify-center gap-1 rounded-lg border-2 border-[#89b29e] bg-[#2a252a] p-0 shadow-lg transition-all duration-300 hover:scale-105 hover:border-[#7ba088] hover:shadow-xl md:left-5"
  id="toggleNavBtn"
  title="Table of contents"
  aria-label="Toggle navigation menu"
  data-sidebar-toggle
>
  <span class="h-0.5 w-5 rounded-sm bg-[#89b29e] transition-all duration-300"
  ></span>
  <span class="h-0.5 w-5 rounded-sm bg-[#89b29e] transition-all duration-300"
  ></span>
  <span class="h-0.5 w-5 rounded-sm bg-[#89b29e] transition-all duration-300"
  ></span>
</button>

<div
  class="pointer-events-none fixed inset-0 z-30 bg-black/50 opacity-0 backdrop-blur-sm transition-opacity duration-300 md:hidden"
  id="backdrop"
  aria-hidden="true"
  data-sidebar-backdrop
>
</div>

<nav
  class="fixed inset-y-0 left-0 z-40 h-screen w-[280px] -translate-x-full overflow-y-auto border-r border-gray-700 bg-[#2a252a] transition-transform duration-300 ease-in-out"
  id="sideNav"
  aria-label="Manual navigation"
  data-sidebar-nav
>
  <div class="py-4">
    <ul class="m-0 list-none p-0">
      {
        navigationItems.map((item) => {
          if ("isChapter" in item && item.isChapter) {
            // Render chapter header - stile minimalista
            return (
              <li>
                <div class="px-4 pt-4 pb-2 text-xs font-semibold tracking-wider text-gray-500 uppercase">
                  {item.title}
                </div>
              </li>
            );
          }

          // Render page item
          const pageItem = item as ManualNavItem;
          return (
            <li>
              <a
                href={pageItem.url}
                class={`group flex items-center gap-3 border-l-4 p-4 text-gray-300 no-underline transition-all duration-300 ${
                  pageItem.active
                    ? "border-l-[#89b29e] bg-[#89b29e]/15 font-bold text-[#89b29e]"
                    : "border-l-transparent hover:border-l-[#89b29e] hover:bg-[#89b29e]/10 hover:text-[#89b29e]"
                } ${pageItem.chapter ? "pl-8" : ""}`}
                data-page={pageItem.slug}
              >
                {!pageItem.chapter && (
                  <span
                    class={`h-1.5 w-1.5 shrink-0 rounded-full transition-colors ${
                      pageItem.active
                        ? "bg-[#89b29e]"
                        : "bg-gray-600 group-hover:bg-[#89b29e]"
                    }`}
                  />
                )}
                {pageItem.chapter && (
                  <span
                    class={`h-1 w-1 shrink-0 rounded-full transition-colors ${
                      pageItem.active
                        ? "bg-[#89b29e]"
                        : "bg-gray-600 group-hover:bg-[#89b29e]"
                    }`}
                  />
                )}
                <span
                  class={`whitespace-nowrap group-hover:underline ${
                    pageItem.active ? "text-[#89b29e]" : ""
                  }`}
                >
                  {pageItem.title}
                </span>
              </a>
            </li>
          );
        })
      }
    </ul>
  </div>
</nav>

<script>
  // Sidebar controller - runs once globally
  class SidebarController {
    private static instance: SidebarController | null = null;
    private sidebar: HTMLElement | null = null;
    private toggleBtn: HTMLElement | null = null;
    private backdrop: HTMLElement | null = null;
    private readonly STORAGE_KEY = "sidebarOpen";
    private readonly MOBILE_BREAKPOINT = 768;

    private constructor() {
      this.init();
    }

    public static getInstance(): SidebarController {
      if (!SidebarController.instance) {
        SidebarController.instance = new SidebarController();
      }
      return SidebarController.instance;
    }

    private init(): void {
      // Get elements using data attributes
      this.sidebar = document.querySelector("[data-sidebar-nav]");
      this.toggleBtn = document.querySelector("[data-sidebar-toggle]");
      this.backdrop = document.querySelector("[data-sidebar-backdrop]");

      if (!this.isValid()) return;

      // Prevent flash on initial load
      document.body.classList.add("preload");

      this.restoreState();

      // Remove preload class after render
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.body.classList.remove("preload");
        });
      });

      this.attachEventListeners();
    }

    private isValid(): boolean {
      return !!(this.sidebar && this.toggleBtn && this.backdrop);
    }

    private restoreState(): void {
      const isOpen = sessionStorage.getItem(this.STORAGE_KEY) === "true";
      if (isOpen) {
        this.openImmediately();
      }
    }

    private saveState(isOpen: boolean): void {
      if (isOpen) {
        sessionStorage.setItem(this.STORAGE_KEY, "true");
      } else {
        sessionStorage.removeItem(this.STORAGE_KEY);
      }
    }

    private isOpen(): boolean {
      return this.sidebar?.classList.contains("translate-x-0") ?? false;
    }

    private openImmediately(): void {
      if (!this.isValid()) return;

      this.sidebar!.classList.remove("-translate-x-full");
      this.sidebar!.classList.add("translate-x-0");
      this.toggleBtn!.classList.add("active");
      this.backdrop!.classList.remove("pointer-events-none", "opacity-0");
      this.backdrop!.classList.add("opacity-100");
      this.saveState(true);
    }

    private open(): void {
      this.openImmediately();
    }

    private close(): void {
      if (!this.isValid()) return;

      this.sidebar!.classList.add("-translate-x-full");
      this.sidebar!.classList.remove("translate-x-0");
      this.toggleBtn!.classList.remove("active");
      this.backdrop!.classList.remove("opacity-100");
      this.backdrop!.classList.add("pointer-events-none", "opacity-0");

      this.saveState(false);
    }

    private toggle(): void {
      if (this.isOpen()) {
        this.close();
      } else {
        this.open();
      }
    }

    private attachEventListeners(): void {
      // Toggle button click
      this.toggleBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        this.toggle();
      });

      // Close on link click (mobile only) - with smooth animation
      const navLinks = this.sidebar?.querySelectorAll("a[data-page]");
      navLinks?.forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth < this.MOBILE_BREAKPOINT) {
            this.close();
          }
        });
      });

      // Close on outside click
      document.addEventListener("click", (e) => {
        const target = e.target as Element;
        if (
          this.isOpen() &&
          !target.closest("[data-sidebar-nav]") &&
          !target.closest("[data-sidebar-toggle]")
        ) {
          this.close();
        }
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && this.isOpen()) {
          this.close();
        }
        if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "m") {
          e.preventDefault();
          this.toggle();
        }
      });
    }

    // Public method to reinitialize after navigation
    public reinit(): void {
      this.sidebar = document.querySelector("[data-sidebar-nav]");
      this.toggleBtn = document.querySelector("[data-sidebar-toggle]");
      this.backdrop = document.querySelector("[data-sidebar-backdrop]");

      if (this.isValid()) {
        this.restoreState();
      }
    }
  }

  // Initialize on first load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () =>
      SidebarController.getInstance(),
    );
  } else {
    SidebarController.getInstance();
  }

  // Handle Astro View Transitions (if enabled in the future)
  document.addEventListener("astro:after-swap", () => {
    SidebarController.getInstance().reinit();
  });
</script>
