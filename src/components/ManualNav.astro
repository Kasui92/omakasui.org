---
import { getCollection } from "astro:content";
import { parseManualCollectionId } from "../utils/manuals";

interface Props {
  id: string;
}

const { id } = Astro.props;
const { group } = parseManualCollectionId(id, true);

const manualPages = (await getCollection("manualsPages"))
  .filter((page) => {
    return page.id.startsWith(`${group}/`);
  })
  .sort((a, b) => {
    const aOrder = parseManualCollectionId(a.id).order;
    const bOrder = parseManualCollectionId(b.id).order;
    return aOrder - bOrder;
  });

const navigationItems = manualPages.map((page) => {
  const { group, slug, title } = parseManualCollectionId(page.id, true);
  return {
    slug,
    title,
    url: `/manuals/${group}${slug === "home" ? "" : `/${slug}`}`,
    active: page.id === id,
  };
});
---

<script is:inline>
  const shouldBeOpen =
    typeof sessionStorage !== "undefined" &&
    sessionStorage.getItem("sidebarOpen") === "true";

  document.write(`
    <button
      class="${shouldBeOpen ? "active " : ""}fixed left-[0.25rem] z-50 flex h-[40px] w-[40px] cursor-pointer flex-col items-center justify-center gap-[4px] rounded-lg border-2 border-[#89b29e] bg-[#2a252a] p-0 shadow-lg transition-all duration-300 hover:scale-105 hover:border-[#7ba088] hover:shadow-xl md:left-[1.25rem]"
      id="toggleNavBtn"
      title="Table of contents"
    >
      <span class="h-[2px] w-[20px] rounded-sm bg-[#89b29e] transition-all duration-300"></span>
      <span class="h-[2px] w-[20px] rounded-sm bg-[#89b29e] transition-all duration-300"></span>
      <span class="h-[2px] w-[20px] rounded-sm bg-[#89b29e] transition-all duration-300"></span>
    </button>

    <nav
      class="fixed inset-y-0 left-0 z-40 h-screen w-[280px] ${shouldBeOpen ? "translate-x-0" : "-translate-x-full"} overflow-y-auto border-r border-gray-700 bg-[#2a252a] transition-transform duration-300 ease-in-out"
      id="sideNav"
    >
  `);
</script>

<div class="py-4">
  <ul class="m-0 list-none p-0">
    {
      navigationItems.map((item, index) => (
        <li class="border-b border-gray-700">
          <a
            href={item.url}
            class={`group flex items-center border-l-4 p-4 text-gray-300 no-underline transition-all duration-300 ${
              item.active
                ? "border-l-[#89b29e] bg-[#89b29e]/15 font-bold text-[#89b29e]"
                : "border-l-transparent hover:border-l-[#89b29e] hover:bg-[#89b29e]/10 hover:text-[#89b29e]"
            }`}
            data-page={item.slug}
          >
            <span
              class={`mr-4 min-w-3 text-left text-base font-bold text-[#89b29e]`}
            >
              {String(index + 1)}.
            </span>
            <span
              class={`whitespace-nowrap group-hover:underline ${
                item.active ? "text-[#89b29e]" : ""
              }`}
            >
              {item.title}
            </span>
          </a>
        </li>
      ))
    }
  </ul>
</div>

<script is:inline>
  document.write(`</nav>`);
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidebar = document.getElementById("sideNav");
    const toggleBtn = document.getElementById("toggleNavBtn");

    if (!sidebar || !toggleBtn) return;

    function updateSidebarState() {
      if (!sidebar) return;
      const isOpen = sidebar.classList.contains("translate-x-0");
      if (isOpen) {
        sessionStorage.setItem("sidebarOpen", "true");
      } else {
        sessionStorage.removeItem("sidebarOpen");
      }
    }

    function toggleSidebar() {
      if (!sidebar || !toggleBtn) return;
      sidebar.classList.toggle("translate-x-0");
      sidebar.classList.toggle("-translate-x-full");
      toggleBtn.classList.toggle("active");
      updateSidebarState();
    }

    function closeSidebar() {
      if (!sidebar || !toggleBtn) return;
      sidebar.classList.add("-translate-x-full");
      sidebar.classList.remove("translate-x-0");
      toggleBtn.classList.remove("active");
      updateSidebarState();
    }

    toggleBtn.addEventListener("click", function (e) {
      e.preventDefault();
      toggleSidebar();
    });

    document.addEventListener("click", function (e) {
      const target = e.target;
      if (target && target instanceof Element) {
        if (
          !target.closest("#sideNav") &&
          !target.closest("[id*='toggleNavBtn']")
        ) {
          closeSidebar();
        }
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        closeSidebar();
      }
      if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "m") {
        e.preventDefault();
        toggleSidebar();
      }
    });
  });
</script>
